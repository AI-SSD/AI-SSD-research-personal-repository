# gdb_trace.cmd - automated GDB tracing for struct sigevent

# Stop at key points
break notifier_free
break notifier_reuse
break mq_notify

# Enable logging
set logging on
set pagination off

# Watch the pointer across the program
# We'll set a watch after first breakpoint
define watch_pointer
  if $arg != 0x0
    watch *(struct sigevent *)$arg
    printf "Watching pointer at %p\n", $arg
  else
    printf "arg is NULL, skipping watch\n"
  end
end

# Print struct safely
define print_sigevent
  if $arg != 0x0
    printf "\n[SIGEVENT DUMP at %p]\n", $arg
    p *(struct sigevent *)$arg
    x/32gx $arg
  else
    printf "\n[SIGEVENT DUMP skipped - NULL pointer]\n"
  end
end

# On hitting notifier_free
commands
  printf "\n--- notifier_free ---\n"
  p arg
  print_sigevent
  watch_pointer
  continue
end

# On hitting notifier_reuse
commands
  printf "\n--- notifier_reuse ---\n"
  p arg
  print_sigevent
  continue
end

# On hitting mq_notify
commands
  printf "\n--- mq_notify called ---\n"
  p arg
  print_sigevent
  continue
end

run
